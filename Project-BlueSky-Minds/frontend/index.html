<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WeatherOdds Pro - AI Weather Prediction</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
      rel="stylesheet" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #000000;
        min-height: 100vh;
        color: #333;
        margin: 0;
        padding: 0;
      }

      /* Space background layer */
      #space-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
        background-color: #000000;
        background-image: radial-gradient(
            circle at 10% 20%,
            rgba(255, 255, 255, 0.8) 0%,
            transparent 1%
          ),
          radial-gradient(
            circle at 90% 80%,
            rgba(255, 255, 255, 0.8) 0%,
            transparent 1%
          ),
          radial-gradient(
            circle at 30% 50%,
            rgba(255, 255, 255, 0.6) 0%,
            transparent 1%
          ),
          radial-gradient(
            circle at 70% 30%,
            rgba(255, 255, 255, 0.9) 0%,
            transparent 1%
          ),
          radial-gradient(
            circle at 50% 70%,
            rgba(255, 255, 255, 0.7) 0%,
            transparent 1%
          ),
          radial-gradient(
            circle at 20% 60%,
            rgba(255, 255, 255, 0.5) 0%,
            transparent 1%
          ),
          radial-gradient(
            circle at 80% 40%,
            rgba(255, 255, 255, 0.8) 0%,
            transparent 1%
          ),
          radial-gradient(
            circle at 40% 90%,
            rgba(255, 255, 255, 0.6) 0%,
            transparent 1%
          ),
          radial-gradient(
            circle at 60% 10%,
            rgba(255, 255, 255, 0.9) 0%,
            transparent 1%
          ),
          radial-gradient(
            circle at 25% 75%,
            rgba(255, 255, 255, 0.7) 0%,
            transparent 1%
          ),
          radial-gradient(
            circle at 75% 25%,
            rgba(255, 255, 255, 0.5) 0%,
            transparent 1%
          ),
          radial-gradient(
            circle at 15% 85%,
            rgba(255, 255, 255, 0.8) 0%,
            transparent 1%
          ),
          radial-gradient(
            circle at 85% 15%,
            rgba(255, 255, 255, 0.6) 0%,
            transparent 1%
          ),
          radial-gradient(
            circle at 45% 45%,
            rgba(255, 255, 255, 0.9) 0%,
            transparent 1%
          ),
          radial-gradient(
            circle at 55% 55%,
            rgba(255, 255, 255, 0.7) 0%,
            transparent 1%
          );
        background-size: 100% 100%;
        animation: twinkle 4s ease-in-out infinite;
      }

      /* Add blue nebula glow */
      

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        position: relative;
        z-index: 1;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 3rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.2rem;
        opacity: 0.9;
      }

      /* TAB NAVIGATION */
      .tab-navigation {
        display: flex;
        background: white;
        border-radius: 15px 15px 0 0;
        overflow: hidden;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 0;
      }

      .tab-button {
        flex: 1;
        padding: 20px;
        border: none;
        background: #f8f9fa;
        color: #666;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
      }

      .tab-button:hover {
        background: #e9ecef;
      }

      .tab-button.active {
        background: white;
        color: #667eea;
        border-bottom: 3px solid #667eea;
      }

      .tab-content {
        display: none;
        background: white;
        border-radius: 0 0 15px 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* CURRENT WEATHER CARD */
      .weather-now-card {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 20px;
      }

      .current-temp {
        font-size: 4rem;
        font-weight: bold;
        margin: 20px 0;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .input-panel {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .map-panel {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
      }

      .coordinate-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .predict-btn {
        width: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .predict-btn:hover {
        transform: translateY(-2px);
      }

      .predict-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      #map {
        height: 400px;
        border-radius: 10px;
      }

      .location-info {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }

      .results-panel {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin-top: 20px;
      }

      .prediction-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 20px;
        text-align: center;
      }

      .prediction-temp {
        font-size: 3rem;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .prediction-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .detail-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }

      .detail-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 5px;
      }

      .detail-label {
        color: #666;
        font-size: 0.9rem;
      }

      .model-performance {
        margin-top: 20px;
      }

      .model-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        margin-bottom: 10px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .model-name {
        font-weight: 600;
      }

      .model-score {
        background: #667eea;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.9rem;
      }

      .loading {
        text-align: center;
        padding: 40px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error {
        background: #ff6b6b;
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
      }

      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2rem;
        }

        .coordinate-inputs {
          grid-template-columns: 1fr;
        }
      }

      .data-source-badge {
        background: #0b3d91;
        color: white;
        padding: 8px 20px;
        border-radius: 20px;
        font-size: 0.9rem;
        display: inline-block;
        margin-top: 10px;
        font-weight: 600;
        box-shadow: 0 2px 10px rgba(11, 61, 145, 0.3);
      }

      .nasa-logo {
        font-weight: bold;
        font-size: 1rem;
      }

      .confidence-bar {
        width: 100%;
        height: 10px;
        background: #e0e0e0;
        border-radius: 5px;
        overflow: hidden;
        margin-top: 10px;
      }

      .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        transition: width 0.5s ease;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .results-panel {
        animation: slideIn 0.5s ease;
      }

      /* Add to your <style> section */
      .prediction-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 20px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .prediction-card::before {
        content: "";
        position: absolute;
        top: 10px;
        right: 10px;
        width: 100px;
        height: 100px;
        background-image: url("YOUR_NASA_LOGO_URL.png");
        background-size: contain;
        background-repeat: no-repeat;
        opacity: 0.15;
      }
    </style>
  </head>
  <body>
    <div id="space-background"></div>
    <div class="container">
      <div class="header">
        <h1>🌡️ WeatherOdds Pro</h1>
        <p>AI-Powered Weather Prediction using NASA Satellite Data</p>
        <img
          src="YOUR_NASA_LOGO_URL.png"
          alt="NASA Logo"
          style="width: 80px; margin-top: 15px; opacity: 0.9" />
        <!-- ADD THIS NEW SECTION -->
        <div style="margin-top: 20px">
          <a
            href="nasa-verification.html"
            style="
              display: inline-block;
              background: linear-gradient(135deg, #10b981 0%, #059669 100%);
              color: white;
              padding: 12px 30px;
              border-radius: 25px;
              text-decoration: none;
              font-weight: bold;
              box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
              transition: transform 0.2s, box-shadow 0.2s;
              font-size: 16px;
            ">
            🛰️ View NASA Data Verification
          </a>
          <div style="margin-top: 15px">
            <span class="data-source-badge">
              <span class="nasa-logo">NASA MERRA-2</span> | Real Satellite Data
            </span>
          </div>
        </div>
        <style>
          a:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6) !important;
          }
        </style>
      </div>
      <!-- ADD TAB NAVIGATION HERE -->
      <div class="tab-navigation">
        <button class="tab-button" onclick="switchTab('current')">
          🌤️ Current Weather
        </button>
        <button class="tab-button active" onclick="switchTab('prediction')">
          🔮 Future Prediction
        </button>
      </div>

      <div id="currentTab" class="tab-content">
        <div class="main-content">
          <!-- Current Weather Input Panel -->
          <div class="input-panel">
            <h2>🌍 Location Selection</h2>
            <div class="form-group">
              <label>🏙️ Quick Location</label>
              <select
                id="quickLocationCurrent"
                onchange="selectQuickLocationCurrent()">
                <option value="">-- Choose a City --</option>
                <option value="19.0760,72.8777">Mumbai, India</option>
                <option value="28.6139,77.2090">Delhi, India</option>
                <option value="30.3165,78.0322">Dehradun, India</option>
              </select>
            </div>

            <div class="form-group">
              <label>📍 Coordinates</label>
              <div class="coordinate-inputs">
                <input
                  type="number"
                  id="latCurrent"
                  placeholder="Latitude"
                  step="0.0001"
                  value="19.0760" />
                <input
                  type="number"
                  id="lonCurrent"
                  placeholder="Longitude"
                  step="0.0001"
                  value="72.8777" />
              </div>
            </div>

            <button class="predict-btn" onclick="getCurrentWeather()">
              ☀️ Get Current Weather
            </button>
          </div>

          <!-- Current Weather Map -->
          <div class="map-panel">
            <h2>🗺️ Map</h2>
            <div
              id="mapCurrent"
              style="height: 400px; border-radius: 10px"></div>
          </div>
        </div>

        <!-- Current Weather Results -->
        <div id="currentResults" style="display: none"></div>
      </div>

      <div id="predictionTab" class="tab-content active">
        <div class="main-content">
          <!-- Input Panel -->
          <div class="input-panel">
            <h2>🎯 Prediction Settings</h2>
            <div class="form-group">
              <label>🌍 Quick Location Select</label>
              <select id="quickLocation" onchange="selectQuickLocation()">
                <option value="">-- Choose a City --</option>
                <option value="19.0760,72.8777">Mumbai, India</option>
                <option value="28.6139,77.2090">Delhi, India</option>
                <option value="30.3165,78.0322">Dehradun, India</option>
                <option value="40.7128,-74.0060">New York, USA</option>
                <option value="51.5074,-0.1278">London, UK</option>
                <option value="35.6762,139.6503">Tokyo, Japan</option>
                <option value="-33.8688,151.2093">Sydney, Australia</option>
              </select>
            </div>

            <div class="form-group">
              <label>📍 Location Coordinates</label>
              <div class="coordinate-inputs">
                <input
                  type="number"
                  id="latitude"
                  placeholder="Latitude"
                  step="0.0001"
                  min="-90"
                  max="90"
                  value="19.0760" />
                <input
                  type="number"
                  id="longitude"
                  placeholder="Longitude"
                  step="0.0001"
                  min="-180"
                  max="180"
                  value="72.8777" />
              </div>
            </div>

            <div class="form-group">
              <label>📅 Future Date</label>
              <input type="date" id="predictionDate" min="2025-09-29" />
            </div>

            <div class="form-group">
              <label>🌡️ Weather Variable</label>
              <select id="weatherVariable">
                <option value="temperature">Temperature</option>
                <option value="precipitation">Precipitation</option>
                <option value="humidity">Humidity</option>
                <option value="wind_speed">Wind Speed</option>
                <option value="pressure">Pressure</option>
              </select>
            </div>

            <div class="form-group">
              <label>📊 Training Years</label>
              <select id="yearsBack">
                <option value="30">30 Years (1995-2024) ⭐ Best</option>
                <option value="20">20 Years (2005-2024)</option>
                <option value="10">10 Years (2015-2024)</option>
                <option value="5">5 Years (2020-2024)</option>
              </select>
            </div>

            <div class="form-group">
              <label>🤖 Prediction Mode</label>
              <select id="predictionMode">
                <option value="live_training">
                  Live ML Training (3-5s, High Accuracy)
                </option>
                <option value="pretrained">
                  Pre-trained Models (Instant, Good Accuracy)
                </option>
              </select>
            </div>

            <button class="predict-btn" onclick="makePrediction()">
              🔮 Predict Weather
            </button>
          </div>

          <!-- Map Panel -->
          <div class="map-panel">
            <h2>🗺️ Interactive Map</h2>
            <div id="map"></div>
            <div id="locationInfo" class="location-info" style="display: none">
              <strong>📍 Selected Location:</strong>
              <div id="locationName">Click on map to select location</div>
              <div id="locationCoords"></div>
            </div>
          </div>
        </div>
        <!-- Results Panel -->
        <div id="resultsPanel" class="results-panel" style="display: none">
          <h2>📊 Prediction Results</h2>
          <div id="predictionResults"></div>
        </div>
      </div>

      <!-- ✅ ADD FOOTER HERE (BEFORE CLOSING </div> OF CONTAINER) -->
      <div
        style="
          background: white;
          border-radius: 15px;
          padding: 25px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
          margin-top: 30px;
          text-align: center;
        ">
        <h3 style="margin-bottom: 15px">📡 Powered by Real NASA Data</h3>
        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
          ">
          <div style="padding: 15px; background: #f8f9fa; border-radius: 10px">
            <div style="font-size: 2rem; margin-bottom: 5px">🛰️</div>
            <div style="font-weight: bold; color: #667eea">NASA MERRA-2</div>
            <div style="font-size: 0.85rem; color: #666; margin-top: 5px">
              Satellite Data (1980-2024)
            </div>
          </div>
          <div style="padding: 15px; background: #f8f9fa; border-radius: 10px">
            <div style="font-size: 2rem; margin-bottom: 5px">🤖</div>
            <div style="font-weight: bold; color: #667eea">ML Algorithms</div>
            <div style="font-size: 0.85rem; color: #666; margin-top: 5px">
              Random Forest, Gradient Boost
            </div>
          </div>
          <div style="padding: 15px; background: #f8f9fa; border-radius: 10px">
            <div style="font-size: 2rem; margin-bottom: 5px">📊</div>
            <div style="font-weight: bold; color: #667eea">Global Coverage</div>
            <div style="font-size: 0.85rem; color: #666; margin-top: 5px">
              Any coordinates on Earth
            </div>
          </div>
          <div style="padding: 15px; background: #f8f9fa; border-radius: 10px">
            <div style="font-size: 2rem; margin-bottom: 5px">⚡</div>
            <div style="font-weight: bold; color: #667eea">
              Real-Time Processing
            </div>
            <div style="font-size: 0.85rem; color: #666; margin-top: 5px">
              3-5 second predictions
            </div>
          </div>
        </div>

        <!-- View Verification Link -->
        <div style="margin-top: 25px">
          <a
            href="nasa-verification.html"
            style="
              display: inline-block;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              padding: 12px 30px;
              border-radius: 25px;
              text-decoration: none;
              font-weight: bold;
              box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
              transition: transform 0.2s;
            ">
            🔍 Verify NASA Data Authenticity
          </a>
        </div>
      </div>
    </div>
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
      // Global variables
      let map;
      let marker;
      const API_BASE = "http://localhost:8000";

      // Tab switching
      function switchTab(tabName) {
        // Hide all tabs
        document.getElementById("currentTab").classList.remove("active");
        document.getElementById("predictionTab").classList.remove("active");

        // Remove active from all buttons
        document.querySelectorAll(".tab-button").forEach((btn) => {
          btn.classList.remove("active");
        });

        // Show selected tab
        if (tabName === "current") {
          document.getElementById("currentTab").classList.add("active");
          document.querySelectorAll(".tab-button")[0].classList.add("active");

          // Initialize map with delay for DOM rendering
          setTimeout(() => {
            if (!window.mapCurrentInitialized) {
              initMapCurrent();
              window.mapCurrentInitialized = true;
            } else if (mapCurrent) {
              // Refresh map size if already initialized
              mapCurrent.invalidateSize();
            }
          }, 100);
        } else {
          document.getElementById("predictionTab").classList.add("active");
          document.querySelectorAll(".tab-button")[1].classList.add("active");
        }
      }
      // Current weather map
      let mapCurrent;
      let markerCurrent;

      function initMapCurrent() {
        const lat = parseFloat(document.getElementById("latCurrent").value);
        const lon = parseFloat(document.getElementById("lonCurrent").value);

        mapCurrent = L.map("mapCurrent").setView([lat, lon], 10);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "© OpenStreetMap",
        }).addTo(mapCurrent);

        markerCurrent = L.marker([lat, lon]).addTo(mapCurrent);

        mapCurrent.on("click", function (e) {
          const newLat = e.latlng.lat.toFixed(4);
          const newLon = e.latlng.lng.toFixed(4);

          document.getElementById("latCurrent").value = newLat;
          document.getElementById("lonCurrent").value = newLon;

          if (markerCurrent) {
            mapCurrent.removeLayer(markerCurrent);
          }
          markerCurrent = L.marker([newLat, newLon]).addTo(mapCurrent);
        });
      }

      // Get current weather
      async function getCurrentWeather() {
        const lat = parseFloat(document.getElementById("latCurrent").value);
        const lon = parseFloat(document.getElementById("lonCurrent").value);

        const resultsDiv = document.getElementById("currentResults");
        resultsDiv.style.display = "block";
        resultsDiv.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <h3>🛰️ Fetching NASA Real-Time Data...</h3>
        </div>
    `;

        try {
          const response = await fetch(
            `${API_BASE}/api/weather/current?latitude=${lat}&longitude=${lon}`
          );

          if (!response.ok) throw new Error("API Error");

          const data = await response.json();
          displayCurrentWeather(data);
        } catch (error) {
          resultsDiv.innerHTML = `
            <div class="error">
                <h3>❌ Error</h3>
                <p>${error.message}</p>
            </div>
        `;
        }
      }

      // Display current weather
      function displayCurrentWeather(data) {
        const weather = data.current_weather;
        const resultsDiv = document.getElementById("currentResults");

        resultsDiv.innerHTML = `
        <div class="results-panel">
            <div class="weather-now-card">
                <h2>☀️ Current Weather</h2>
                <div class="current-temp">${weather.current_temperature}°C</div>
                <p style="font-size: 1.2rem; opacity: 0.9;">Feels like ${
                  weather.feels_like
                }°C</p>
                <p style="margin-top: 10px;">📍 ${weather.location}</p>
            </div>
            
            <div class="prediction-details">
                <div class="detail-card">
                    <div class="detail-value">${weather.humidity}%</div>
                    <div class="detail-label">💧 Humidity</div>
                </div>
                <div class="detail-card">
                    <div class="detail-value">${weather.wind_speed} m/s</div>
                    <div class="detail-label">🌬️ Wind Speed</div>
                </div>
                <div class="detail-card">
                    <div class="detail-value">${weather.pressure} hPa</div>
                    <div class="detail-label">🌡️ Pressure</div>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <p><strong>📡 Source:</strong> ${data.source}</p>
                <p><strong>🎯 Accuracy:</strong> ${data.accuracy}</p>
                <p><strong>⏰ Updated:</strong> ${new Date(
                  weather.timestamp
                ).toLocaleString()}</p>
            </div>
        </div>
    `;
      }

      // Quick location for current tab
      function selectQuickLocationCurrent() {
        const select = document.getElementById("quickLocationCurrent");
        const value = select.value;

        if (value) {
          const [lat, lon] = value.split(",");
          document.getElementById("latCurrent").value = lat;
          document.getElementById("lonCurrent").value = lon;

          if (mapCurrent) {
            mapCurrent.setView([lat, lon], 10);
            if (markerCurrent) mapCurrent.removeLayer(markerCurrent);
            markerCurrent = L.marker([lat, lon]).addTo(mapCurrent);
          }
        }
      }

      // Initialize map
      function initMap() {
        map = L.map("map").setView([19.076, 72.8777], 10); // Mumbai initial view

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "© OpenStreetMap contributors",
        }).addTo(map);

        // Add click handler
        map.on("click", function (e) {
          const lat = e.latlng.lat.toFixed(4);
          const lon = e.latlng.lng.toFixed(4);

          // Update coordinates
          document.getElementById("latitude").value = lat;
          document.getElementById("longitude").value = lon;

          // Update marker
          if (marker) {
            map.removeLayer(marker);
          }
          marker = L.marker([lat, lon]).addTo(map);

          // Get location name
          getLocationName(lat, lon);
        });

        // Set initial marker
        const initialLat = document.getElementById("latitude").value;
        const initialLon = document.getElementById("longitude").value;
        if (initialLat && initialLon) {
          marker = L.marker([initialLat, initialLon]).addTo(map);
          getLocationName(initialLat, initialLon);
        }
      }

      // Get location name from coordinates
      async function getLocationName(lat, lon) {
        try {
          const response = await fetch(
            `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`
          );
          const data = await response.json();

          const locationInfo = document.getElementById("locationInfo");
          const locationName = document.getElementById("locationName");
          const locationCoords = document.getElementById("locationCoords");

          locationName.textContent =
            data.city ||
            data.locality ||
            data.principalSubdivision ||
            "Unknown Location";
          locationCoords.textContent = `${lat}°, ${lon}°`;
          locationInfo.style.display = "block";
        } catch (error) {
          console.error("Error getting location name:", error);
          const locationInfo = document.getElementById("locationInfo");
          const locationName = document.getElementById("locationName");
          const locationCoords = document.getElementById("locationCoords");

          locationName.textContent = "Location";
          locationCoords.textContent = `${lat}°, ${lon}°`;
          locationInfo.style.display = "block";
        }
      }

      // Make weather prediction
      async function makePrediction() {
        const latitude = parseFloat(document.getElementById("latitude").value);
        const longitude = parseFloat(
          document.getElementById("longitude").value
        );
        const date = document.getElementById("predictionDate").value;
        const variable = document.getElementById("weatherVariable").value;
        const yearsBack = parseInt(document.getElementById("yearsBack").value);
        const predictionMode = document.getElementById("predictionMode").value;

        // Validation
        if (!latitude || !longitude || !date) {
          alert("Please fill in all required fields");
          return;
        }

        if (latitude < -90 || latitude > 90) {
          alert("Latitude must be between -90 and 90");
          return;
        }

        if (longitude < -180 || longitude > 180) {
          alert("Longitude must be between -180 and 180");
          return;
        }

        // Show loading
        const resultsPanel = document.getElementById("resultsPanel");
        resultsPanel.style.display = "block";
        resultsPanel.innerHTML = `
    <div class="loading">
        <div class="spinner"></div>
        <h3>🛰️ Fetching NASA Satellite Data...</h3>
        <p style="margin-top: 10px;">Analyzing ${yearsBack} years (${
          2025 - yearsBack
        }-2024) of MERRA-2 measurements</p>
        <p style="margin-top: 5px; font-size: 0.9rem; opacity: 0.8;">
            ${
              predictionMode === "live_training"
                ? "🤖 Training Random Forest, Gradient Boost, and Elastic Net models..."
                : "⚡ Using pre-trained models for instant prediction..."
            }
        </p>
    </div>
`;

        try {
          const response = await fetch(
            `${API_BASE}/api/weather/probability/simple`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                latitude: latitude,
                longitude: longitude,
                date: date,
                variables: [variable],
                years_back: yearsBack,
                prediction_mode: predictionMode,
              }),
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          displayResults(data, variable);
        } catch (error) {
          console.error("Error making prediction:", error);
          resultsPanel.innerHTML = `
                    <div class="error">
                        <h3>❌ Prediction Failed</h3>
                        <p>Error: ${error.message}</p>
                                                <p>Please check if the backend server is running on localhost:8000</p>
                    </div>
                `;
        }
      }

      // Display prediction results
      function displayResults(data, variable) {
        const resultsPanel = document.getElementById("resultsPanel");
        const prediction = data.prediction;
        const modelPerformance = data.model_performance;
        const trainingInfo = data.training_info;

        // Get unit based on variable
        const units = {
          temperature: "°C",
          precipitation: "mm",
          humidity: "%",
          wind_speed: "m/s",
          pressure: "hPa",
        };
        const unit = units[variable] || "";

        resultsPanel.innerHTML = `
                <h2>📊 Prediction Results</h2>
                
                <!-- Main Prediction Card -->
                <div class="prediction-card">
                    <div class="prediction-temp">${
                      prediction.temperature
                    }${unit}</div>
                    <h3>📍 ${data.location.latitude}°, ${
          data.location.longitude
        }°</h3>
                    <p>📅 ${new Date(prediction.date).toLocaleDateString(
                      "en-US",
                      {
                        weekday: "long",
                        year: "numeric",
                        month: "long",
                        day: "numeric",
                      }
                    )}</p>
                </div>

                <!-- Prediction Details -->
                <div class="prediction-details">
                   <div class="detail-card">
    <div class="detail-value">${prediction.confidence}%</div>
    <div class="detail-label">🎯 Confidence</div>
    <div class="confidence-bar">
        <div class="confidence-fill" style="width: ${
          prediction.confidence
        }%"></div>
    </div>
</div>
                    <div class="detail-card">
                        <div class="detail-value">${prediction.accuracy}</div>
                        <div class="detail-label">📈 Accuracy</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-value">${prediction.method}</div>
                        <div class="detail-label">🤖 Method</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-value">${
                          trainingInfo.data_points
                        }</div>
                        <div class="detail-label">📊 Training Data</div>
                    </div>
                </div>

                <!-- Model Performance -->
                <div class="model-performance">
                    <h3>🧠 ML Model Performance</h3>
                    <div class="model-item">
                        <span class="model-name">🏆 Best Model</span>
                        <span class="model-score">${
                          modelPerformance.best_model
                        }</span>
                    </div>
                    ${Object.entries(modelPerformance.individual_models)
                      .map(
                        ([model, score]) => `
                        <div class="model-item">
                            <span class="model-name">${model
                              .replace("_", " ")
                              .toUpperCase()}</span>
                            <span class="model-score">CV: ${score.toFixed(
                              3
                            )}</span>
                        </div>
                    `
                      )
                      .join("")}
                </div>

                <!-- Training Information -->
                <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h4>📡 Training Information</h4>
                    <p><strong>Data Source:</strong> ${
                      trainingInfo.data_source
                    }</p>
                    <p><strong>Training Period:</strong> ${
                      trainingInfo.training_period
                    }</p>
                    <p><strong>Features Used:</strong> ${
                      trainingInfo.features_used
                    }</p>
                    <p><strong>Generated:</strong> ${new Date(
                      data.timestamp
                    ).toLocaleString()}</p>
                </div>

                <!-- Verification Note -->
                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; text-align: center;">
                    <h4>🔮 Future Prediction</h4>
                    <p>This prediction can be verified on ${new Date(
                      prediction.date
                    ).toLocaleDateString()}!</p>
                    <p>Our AI system analyzed ${
                      trainingInfo.data_points
                    } of NASA satellite data to make this prediction.</p>
                </div>
            `;
      }

      // Set minimum date to tomorrow
      function setMinDate() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const minDate = tomorrow.toISOString().split("T")[0];
        document.getElementById("predictionDate").min = minDate;
        document.getElementById("predictionDate").value = minDate;
      }

      // Update coordinates when input changes
      function updateMapFromInputs() {
        const lat = parseFloat(document.getElementById("latitude").value);
        const lon = parseFloat(document.getElementById("longitude").value);

        if (
          lat &&
          lon &&
          lat >= -90 &&
          lat <= 90 &&
          lon >= -180 &&
          lon <= 180
        ) {
          map.setView([lat, lon], 10);

          if (marker) {
            map.removeLayer(marker);
          }
          marker = L.marker([lat, lon]).addTo(map);
          getLocationName(lat, lon);
        }
      }

      // Add event listeners for coordinate inputs
      document
        .getElementById("latitude")
        .addEventListener("change", updateMapFromInputs);
      document
        .getElementById("longitude")
        .addEventListener("change", updateMapFromInputs);

      // Initialize everything when page loads
      document.addEventListener("DOMContentLoaded", function () {
        initMap();
        setMinDate();

        // Initialize current weather map immediately
        setTimeout(() => {
          if (
            document.getElementById("currentTab").classList.contains("active")
          ) {
            initMapCurrent();
          }
        }, 100);
      });

      // Test backend connection
      async function testBackendConnection() {
        try {
          const response = await fetch(`${API_BASE}/api/health`);
          if (response.ok) {
            console.log("✅ Backend connection successful");
          } else {
            console.warn("⚠️ Backend responded with error:", response.status);
          }
        } catch (error) {
          console.error("❌ Backend connection failed:", error);
          alert(
            "⚠️ Cannot connect to backend server. Please ensure the server is running on localhost:8000"
          );
        }
      }

      // Test connection on page load
      testBackendConnection();

      // Quick location selector
      function selectQuickLocation() {
        const select = document.getElementById("quickLocation");
        const value = select.value;

        if (value) {
          const [lat, lon] = value.split(",");
          document.getElementById("latitude").value = lat;
          document.getElementById("longitude").value = lon;
          updateMapFromInputs();
        }
      }
    </script>
  </body>
</html>
